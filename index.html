<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Veri*Factu Business - Automatiza tu facturaci√≥n con IA</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon-verifactu.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="page">
      <header class="header">
        <div class="container header__inner">
          <a href="#hero" class="brand" aria-label="Volver al inicio">
            <img
              src="assets/logo-verifactu-business.svg"
              alt="VeriFactu Business"
              class="brand__image"
            />
          </a>

          <nav class="nav">
            <a href="#features">Producto</a>
            <a href="#workflow">VeriFactu</a>
            <a href="#pricing">Planes</a>
            <a href="#resources">Recursos</a>
          </nav>

          <div class="header__cta">
            <button class="btn btn--ghost" type="button" data-lead-open="login">
              Acceder
            </button>
            <button class="btn btn--primary" type="button" data-lead-open="demo">
              Solicitar demo
            </button>
          </div>
        </div>
      </header>

      <main>
        <section id="hero" class="hero">
          <div class="hero__background" aria-hidden="true"></div>

          <div class="container hero__inner">
            <div class="hero__copy">
              <p class="hero__eyebrow">Cumple con VeriFactu y haz crecer tu negocio.</p>
              <h1>La forma m√°s inteligente de automatizar tu facturaci√≥n.</h1>
              <p class="hero__description">
                Isaak centraliza la emisi√≥n, valida con AEAT y te sugiere c√≥mo mejorar tus m√°rgenes autom√°ticamente.
              </p>

              <div class="hero__actions">
                <button class="btn btn--primary" type="button" data-lead-open="register">
                  Comenzar ahora
                </button>
                <button class="btn btn--ghost" type="button" data-lead-open="demo">
                  Solicitar demo
                </button>
              </div>

              <div class="hero__trust">
                <span>Equipos fiscales, asesor√≠as y despachos conf√≠an en Isaak.</span>
              </div>
            </div>

            <div class="hero__mockup" aria-hidden="true">
              <div class="mockup mockup--assistant">
                <header class="mockup__header">
                  <div>
                    <span class="mockup__badge">Isaak IA</span>
                    <p class="mockup__title">Estado diario del negocio</p>
                  </div>
                  <span class="mockup__status">Conectado</span>
                </header>
                <div class="mockup__body">
                  <article class="mockup__message">
                    <span class="mockup__avatar">ü§ñ</span>
                    <div>
                      <p class="mockup__label">Isaak</p>
                      <p class="mockup__text">
                        Ingresos del mes +18% vs. objetivo. ¬øAgendamos revisi√≥n para impuestos?
                      </p>
                    </div>
                  </article>

                  <article class="mockup__message mockup__message--light">
                    <span class="mockup__avatar">ü§ñ</span>
                    <div>
                      <p class="mockup__label">Isaak</p>
                      <p class="mockup__text">
                        Tu env√≠o VeriFactu se ha validado. Preparando informe de m√°rgenes.
                      </p>
                    </div>
                  </article>

                  <article class="mockup__message">
                    <span class="mockup__avatar">ü§ñ</span>
                    <div>
                      <p class="mockup__label">Isaak</p>
                      <p class="mockup__text">
                        Detect√© suscripciones duplicadas. Ahorro potencial de 240 ‚Ç¨ trimestrales.
                      </p>
                    </div>
                  </article>
                </div>
              </div>

              <div class="mockup mockup--snapshot">
                <header>
                  <span class="snapshot__title">Resumen VeriFactu</span>
                  <span class="snapshot__chip">Cumplimiento 100%</span>
                </header>
                <div class="snapshot__grid">
                  <div>
                    <p class="snapshot__label">Beneficio neto</p>
                    <p class="snapshot__value">12.450 ‚Ç¨</p>
                    <span class="snapshot__trend snapshot__trend--up">+18% mensual</span>
                  </div>
                  <div>
                    <p class="snapshot__label">Facturas enviadas</p>
                    <p class="snapshot__value">156</p>
                    <span class="snapshot__trend">VeriFactu autom√°tico</span>
                  </div>
                  <div>
                    <p class="snapshot__label">Alertas activas</p>
                    <p class="snapshot__value">0</p>
                    <span class="snapshot__trend snapshot__trend--safe">Isaak vigila</span>
                  </div>
                </div>
              </div>

              <div class="mockup mockup--invoice">
                <header>
                  <div>
                    <span class="invoice__title">Factura VF-2031</span>
                    <p class="invoice__subtitle">Estudio Creativo Nova</p>
                  </div>
                  <span class="invoice__status">Pagada</span>
                </header>
                <dl class="invoice__details">
                  <div><dt>Emisi√≥n</dt><dd>12 Feb 2025</dd></div>
                  <div><dt>Importe</dt><dd>1.250,00 ‚Ç¨</dd></div>
                  <div><dt>AEAT</dt><dd>Enviada</dd></div>
                </dl>
                <div class="invoice__footer">
                  <div class="invoice__qr" role="img" aria-label="C√≥digo QR factura"></div>
                  <p>Isaak confirma la validez VeriFactu y el cobro.</p>
                </div>
              </div>
            </div>
          </div>

          <div class="hero__stats">
            <div class="container hero__stats-grid">
              <div>
                <p class="stat__value">+350%</p>
                <p class="stat__label">Productividad en equipos fiscales</p>
              </div>
              <div>
                <p class="stat__value">100%</p>
                <p class="stat__label">Cumplimiento Real Decreto 1007/2023</p>
              </div>
              <div>
                <p class="stat__value">24/7</p>
                <p class="stat__label">Asistencia y recomendaciones con Isaak</p>
              </div>
            </div>
          </div>
        </section>

        <section id="features" class="section features">
          <div class="container">
            <div class="section__header">
              <h2>Una plataforma creada para liderar tu VeriFactu.</h2>
              <p>
                Centraliza la emisi√≥n, validaci√≥n y an√°lisis de tu facturaci√≥n con paneles dise√±ados para asesor√≠as,
                despachos y empresas que necesitan precisi√≥n.
              </p>
            </div>

            <div class="features__grid">
              <article class="feature-card">
                <h3>Automatizaci√≥n total</h3>
                <p>Emite facturas con plantillas inteligentes y sincroniza tus libros con un clic.</p>
                <span>Firmas digitales incluidas</span>
              </article>

              <article class="feature-card">
                <h3>VeriFactu integrado</h3>
                <p>Env√≠o y validaci√≥n en tiempo real con seguimiento de estados y evidencias legales.</p>
                <span>Notificaciones autom√°ticas</span>
              </article>

              <article class="feature-card">
                <h3>Insights accionables</h3>
                <p>Analiza m√°rgenes, cashflow y proyecciones con escenarios sugeridos por IA.</p>
                <span>Informes listos para clientes</span>
              </article>

              <article class="feature-card">
                <h3>Colaboraci√≥n segura</h3>
                <p>Roles, permisos y auditor√≠a completa con copias cifradas en la nube.</p>
                <span>Certificado digital incluido</span>
              </article>
            </div>
          </div>
        </section>

        <section id="workflow" class="section workflow">
          <div class="container">
            <div class="section__header">
              <h2>Del env√≠o al cobro en tres pasos.</h2>
              <p>
                Conecta tu ERP o empieza desde cero: Isaak gu√≠a a tu equipo, automatiza verificaciones y mantiene el
                control fiscal sin esfuerzo.
              </p>
            </div>

            <div class="workflow__steps">
              <article class="step">
                <span class="step__number">1</span>
                <h3>Configura Isaak</h3>
                <p>Importa tus datos, define reglas de facturaci√≥n y activa recordatorios personalizados.</p>
              </article>

              <article class="step">
                <span class="step__number">2</span>
                <h3>Emite y valida</h3>
                <p>Genera la factura, firma autom√°ticamente y env√≠ala a AEAT VeriFactu sin abandonar la plataforma.</p>
              </article>

              <article class="step">
                <span class="step__number">3</span>
                <h3>Cobra y analiza</h3>
                <p>Isaak monitoriza el cobro, detecta incidencias y propone acciones para mejorar tus m√°rgenes.</p>
              </article>
            </div>
          </div>
        </section>

        <section id="dashboard" class="section dashboard">
          <div class="container">
            <div class="section__header">
              <h2>Un dashboard que aprende de tu negocio.</h2>
              <p>
                Isaak acompa√±a a tu equipo con soporte, formaci√≥n y automatizaciones que detectan necesidades de
                facturaci√≥n, contabilidad y tesorer√≠a en tiempo real.
              </p>
            </div>

            <div class="dashboard__layout">
              <div class="dashboard__preview" aria-hidden="true">
                <div class="dashboard__screen">
                  <div class="dashboard__screen-header">
                    <span>Isaak Control Center</span>
                    <span class="dashboard__badge">Suscripci√≥n Business Plus</span>
                  </div>

                  <div class="dashboard__metrics">
                    <div class="dashboard__metric">
                      <span class="dashboard__metric-label">Ventas del mes</span>
                      <strong class="dashboard__metric-value">‚Ç¨48.230</strong>
                      <span class="dashboard__metric-trend">+8,2% vs. febrero</span>
                    </div>
                    <div class="dashboard__metric">
                      <span class="dashboard__metric-label">Cobros</span>
                      <strong class="dashboard__metric-value">‚Ç¨36.900</strong>
                      <span class="dashboard__metric-trend">12 facturas por conciliar</span>
                    </div>
                    <div class="dashboard__metric">
                      <span class="dashboard__metric-label">Beneficio neto</span>
                      <strong class="dashboard__metric-value">‚Ç¨12.410</strong>
                      <span class="dashboard__metric-trend">Impuesto estimado: ‚Ç¨2.136</span>
                    </div>
                  </div>

                  <div class="dashboard__assistant-bubble">
                    <p>
                      Hola, soy Isaak üëã He detectado tickets pendientes de gasto. ¬øQuieres que los contabilice y programe
                      recordatorios de pago?
                    </p>
                    <div class="dashboard__actions">
                      <button type="button">Revisar con Isaak</button>
                      <button type="button" class="ghost">Recordar m√°s tarde</button>
                    </div>
                  </div>

                  <div class="dashboard__panels">
                    <div class="dashboard__panel">
                      <h4>Importaciones activas</h4>
                      <ul>
                        <li><strong>Clientes</strong> ¬∑ 1.240 registros sincronizados</li>
                        <li><strong>Proveedores</strong> ¬∑ Integraci√≥n Drive completada</li>
                        <li><strong>Productos</strong> ¬∑ Nuevos art√≠culos listos para venta</li>
                      </ul>
                    </div>
                    <div class="dashboard__panel">
                      <h4>Acciones sugeridas</h4>
                      <ul>
                        <li>Generar presupuesto r√°pido para ¬´Proyecto Atlas¬ª</li>
                        <li>Emitir factura proforma y env√≠o autom√°tico AEAT</li>
                        <li>Planificar formaci√≥n onboarding para nuevo asesor</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>

              <div class="dashboard__content">
                <h3>Soporte proactivo y gesti√≥n total desde cualquier dispositivo.</h3>
                <p>
                  Accede con registro tradicional o Google OAuth y deja que Isaak personalice el espacio de trabajo:
                  flujos de cobros y documentaci√≥n disponible para tu equipo.
                </p>
                <ul class="dashboard__list">
                  <li><strong>Suscripciones bajo control:</strong> gestiona planes, l√≠mites de usuarios y permisos.</li>
                  <li><strong>Importaci√≥n / exportaci√≥n guiada:</strong> Isaak limpia y clasifica datos.</li>
                  <li><strong>Operativa contable asistida:</strong> presupuestos, proformas y tickets desde m√≥vil/email.</li>
                  <li><strong>Finanzas al d√≠a:</strong> visualiza impagos, gastos, beneficio neto e impuestos sugeridos.</li>
                </ul>

                <div class="dashboard__cta">
                  <a class="btn btn--primary" href="/app/signup">Probar gratis 30 d√≠as</a>
                  <p>Sin compromiso ni datos de pago. Isaak te gu√≠a desde el primer acceso.</p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="section compliance">
          <div class="container compliance__inner">
            <div class="compliance__content">
              <h2>100% cumplimiento VeriFactu certificado.</h2>
              <p>
                Veri*Factu Business cumple con el Real Decreto 1007/2023 y mantiene tu evidencia fiscal siempre actualizada.
              </p>
              <ul class="compliance__list">
                <li>‚úÖ Firma digital autom√°tica</li>
                <li>‚úÖ Comunicaci√≥n cifrada con AEAT</li>
                <li>‚úÖ Copias de seguridad en la nube</li>
                <li>‚úÖ Certificado digital incluido</li>
              </ul>
            </div>

            <div class="compliance__badge" aria-hidden="true">
              <div class="compliance__shield">VeriFactu</div>
              <p>Cumplimiento verificado</p>
            </div>
          </div>
        </section>

        <section id="pricing" class="pricing">
          <div class="container">
            <div class="pricing__header">
              <h2>Planes y precios</h2>
              <p>Elige cuota fija y deja que Isaak calcule el % sobre tus ventas.</p>
              <p class="pricing__sub">
                Todos los planes incluyen 30 d√≠as gratis, sin compromiso y sin datos de pago.
              </p>
            </div>

            <div class="pricing__control card">
              <label for="vf-sales">Ventas mensuales estimadas</label>
              <div class="pricing__control-right">
                <input id="vf-sales" type="number" min="0" step="100" value="10000" />
                <span>‚Ç¨</span>
              </div>
            </div>

            <div id="vf-pricing-grid" class="pricing__grid">
              <!-- Renderizado por JS -->
            </div>

            <div class="pricing__note">
              * El % se aplica √∫nicamente a ventas facturadas en la app. C√°lculo orientativo.
            </div>
          </div>
        </section>

        <section id="resources" class="section resources">
          <div class="container">
            <div class="section__header">
              <h2>Recursos para dominar VeriFactu e Isaak.</h2>
              <p>Gu√≠as, webinars y checklists para sacar el m√°ximo a la plataforma.</p>
            </div>

            <div class="resources__grid">
              <article class="resource-card">
                <span class="resource-card__category">Gu√≠a</span>
                <h3>Manual VeriFactu 2025</h3>
                <p>Checklists y ejemplos aplicables preparados por equipo fiscal.</p>
                <button class="resource-card__action" type="button" data-lead-open="guide">
                  Descargar gu√≠a
                </button>
              </article>

              <article class="resource-card">
                <span class="resource-card__category">Webinar</span>
                <h3>Onboarding con Isaak IA</h3>
                <p>Configura automatizaciones, alertas y env√≠os en vivo.</p>
                <button class="resource-card__action" type="button" data-lead-open="webinar">
                  Reservar plaza
                </button>
              </article>

              <article class="resource-card">
                <span class="resource-card__category">Checklist</span>
                <h3>Auditor√≠a express de facturaci√≥n</h3>
                <p>Eval√∫a el ciclo de facturaci√≥n con recomendaciones de Isaak.</p>
                <button class="resource-card__action" type="button" data-lead-open="resources">
                  Solicitar checklist
                </button>
              </article>
            </div>
          </div>
        </section>

        <section id="cta" class="section final-cta">
          <div class="container final-cta__inner">
            <div class="final-cta__content">
              <h2>Factura menos. Vive m√°s.</h2>
              <p>Isaak IA automatiza tu contabilidad y te devuelve tiempo para lo importante.</p>
            </div>
            <div class="final-cta__actions">
              <button class="btn btn--primary" type="button" data-lead-open="register">Registrarse</button>
              <button class="btn btn--ghost" type="button" data-lead-open="trial">Empezar gratis 30 d√≠as</button>
            </div>
          </div>
        </section>
      </main>

      <footer class="footer">
        <div class="container footer__grid">
          <div class="footer__brand">
            <img src="assets/logo-verifactu-business.svg" alt="VeriFactu Business" class="brand__image" />
            <p>Automatiza tu facturaci√≥n con IA y cumplimiento VeriFactu certificado.</p>
            <a class="footer__contact" href="mailto:soporte@verifactu.business">soporte@verifactu.business</a>
          </div>

          <div class="footer__column">
            <h4>Producto</h4>
            <ul>
              <li><a href="#hero">Resumen</a></li>
              <li><a href="#features">Plataforma</a></li>
              <li><a href="#workflow">Automatizaci√≥n</a></li>
            </ul>
          </div>

          <div class="footer__column">
            <h4>VeriFactu</h4>
            <ul>
              <li><a href="#workflow">Flujo oficial</a></li>
              <li><a href="#pricing">Planes y precios</a></li>
              <li><a href="#cta">Soporte</a></li>
            </ul>
          </div>

          <div class="footer__column">
            <h4>Recursos</h4>
            <ul>
              <li><a href="#resources">Gu√≠as y webinars</a></li>
              <li><a href="#resources">Checklist</a></li>
              <li>
                <button class="footer__link-button" type="button" data-lead-open="demo">Solicitar demo</button>
              </li>
            </ul>
          </div>
        </div>

        <div class="container footer__bottom">
          <p>¬© 2025 Veri*Factu Business ¬∑ Todos los derechos reservados</p>
          <div class="footer__legal-links">
            <a href="#privacy">Pol√≠tica de Privacidad</a>
            <a href="#terms">Condiciones de Uso</a>
            <a href="#cookies">Cookies</a>
          </div>
        </div>
      </footer>
    </div>

    <!-- Lead Modal -->
    <div class="lead-modal" id="lead-modal" aria-hidden="true">
      <div class="lead-modal__backdrop" data-lead-close></div>

      <div class="lead-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="lead-modal-title">
        <button class="lead-modal__close" type="button" aria-label="Cerrar formulario" data-lead-close>√ó</button>

        <h2 id="lead-modal-title">Conversemos sobre Veri*Factu Business</h2>
        <p class="lead-modal__intro">
          D√©janos tus datos y activaremos el flujo adecuado: acceso a la plataforma, demo con Isaak o configuraci√≥n guiada.
        </p>

        <form class="lead-form" autocomplete="on">
          <input type="hidden" name="interest" value="register" />

          <div class="lead-form__grid">
            <label class="lead-form__field">
              <span>Nombre completo</span>
              <input type="text" name="name" placeholder="Mar√≠a Garc√≠a" required />
            </label>

            <label class="lead-form__field">
              <span>Correo electr√≥nico</span>
              <input type="email" name="email" placeholder="tu@empresa.com" required />
            </label>
          </div>

          <label class="lead-form__field">
            <span>Empresa</span>
            <input type="text" name="company" placeholder="Nombre de tu empresa" />
          </label>

          <label class="lead-form__field">
            <span>Cu√©ntanos qu√© necesitas</span>
            <textarea name="message" rows="4" placeholder="Quiero automatizar mis facturas y validar con AEAT..."></textarea>
          </label>

          <div class="lead-form__footer">
            <p class="lead-form__hint">
              Usaremos estos datos para responder desde <strong>soporte@verifactu.business</strong>.
            </p>
            <button class="btn btn--primary" type="submit">Enviar solicitud</button>
          </div>

          <p class="lead-form__status" role="status" aria-live="polite"></p>
        </form>
      </div>
    </div>

    <!-- Isaak Chat (seguro: llama a /api/vertex-chat) -->
    <button class="isaak-fab" type="button" aria-controls="isaak-chat" aria-expanded="false">
      <span class="isaak-fab__avatar">ü§ñ</span>
      <span class="isaak-fab__label">Habla con Isaak</span>
    </button>

    <section class="isaak-chat" id="isaak-chat" aria-hidden="true">
      <header class="isaak-chat__header">
        <div>
          <span class="isaak-chat__avatar">ü§ñ</span>
          <div>
            <p class="isaak-chat__title">Isaak, asistente fiscal</p>
            <p class="isaak-chat__status">Proactivo ¬∑ Conectado a tu configuraci√≥n</p>
          </div>
        </div>

        <button class="isaak-chat__close" type="button" aria-label="Cerrar chat">√ó</button>
      </header>

      <div class="isaak-chat__proactive" role="log" aria-live="polite"></div>
      <div class="isaak-chat__messages" role="list"></div>

      <form class="isaak-chat__form" autocomplete="off">
        <label class="sr-only" for="isaak-input">Escribe tu mensaje</label>
        <input id="isaak-input" name="message" type="text" placeholder="Pregunta a Isaak sobre tu facturaci√≥n" required />
        <button type="submit">Enviar</button>
      </form>
    </section>

    <script>
      // Pricing din√°mico (igual concepto que tu patch)
      (function () {
        const PLANS = [
          { name: "Starter", price: 9.9, variablePct: 0.005, users: "1 usuario", ctaLabel: "Probar gratis", ctaHref: "/app/signup",
            features: ["Env√≠o AEAT VeriFactu", "Soporte b√°sico", "Isaak IA (b√°sico)", "30 d√≠as gratis. Sin compromiso ni datos de pago."], highlight: false
          },
          { name: "Professional", price: 24.9, variablePct: 0.003, users: "3 usuarios", ctaLabel: "Empezar", ctaHref: "/app/signup",
            features: ["Dashboard avanzado", "Informes autom√°ticos IA", "Integraci√≥n nubes/correos", "30 d√≠as gratis. Sin compromiso ni datos de pago."], highlight: true
          },
          { name: "Business Plus", price: 49.9, variablePct: 0.002, users: "Hasta 10 usuarios", ctaLabel: "Solicitar demo", ctaHref: "/demo",
            features: ["Multiempresa", "API avanzada", "Soporte prioritario", "30 d√≠as gratis. Sin compromiso ni datos de pago."], highlight: false
          },
          { name: "Enterprise", price: 0, variablePct: 0.001, users: "Ilimitado", ctaLabel: "Contactar", ctaHref: "/contact",
            features: ["Integraciones a medida", "Auditor√≠a fiscal avanzada", "Agente Isaak dedicado", "30 d√≠as gratis. Sin compromiso ni datos de pago."], highlight: false
          },
        ];

        const grid = document.getElementById("vf-pricing-grid");
        const sales = document.getElementById("vf-sales");

        function currency(n) {
          return n.toLocaleString("es-ES", { style: "currency", currency: "EUR" });
        }

        function getMonthlySales() {
          const value = Number(sales.value);
          return Number.isFinite(value) && value > 0 ? value : 0;
        }

        function render() {
          const monthlySales = getMonthlySales();
          grid.innerHTML = "";

          PLANS.forEach((plan) => {
            const variableFee = plan.variablePct * monthlySales;
            const total = (plan.price || 0) + variableFee;

            const card = document.createElement("div");
            card.className = "pricing-card" + (plan.highlight ? " pricing-card--highlight" : "");

            card.innerHTML = `
              <div class="pricing-card__top">
                <h3>${plan.name}</h3>
                <span>${plan.users}</span>
              </div>

              <div class="pricing-card__price">
                ${plan.price > 0 ? `<div class="price">${currency(plan.price)} <small>/mes</small></div>` : `<div class="price">A medida</div>`}
                <div class="line">Comisi√≥n variable: <b>${(plan.variablePct * 100).toFixed(1)}%</b> sobre ventas</div>
                <div class="line">Estimaci√≥n variable: <b>${currency(variableFee)}</b> / mes</div>
                <div class="line total">Total estimado: <b>${currency(total)}</b> / mes</div>
              </div>

              <ul class="pricing-card__list">
                ${plan.features.map((f) => `<li>${f}</li>`).join("")}
              </ul>

              <a class="pricing-card__cta" href="${plan.ctaHref}">${plan.ctaLabel}</a>
            `;

            grid.appendChild(card);
          });
        }

        sales.addEventListener("input", render);
        render();
      })();

      // Lead modal ‚Üí /api/send-lead
      (function () {
        const leadModal = document.getElementById("lead-modal");
        const leadForm = leadModal.querySelector(".lead-form");
        const leadStatus = leadForm.querySelector(".lead-form__status");
        const leadInterestInput = leadForm.querySelector("input[name='interest']");
        const leadCloseButtons = leadModal.querySelectorAll("[data-lead-close]");
        const leadTriggers = document.querySelectorAll("[data-lead-open]");
        const leadSubmitButton = leadForm.querySelector("button[type='submit']");
        leadSubmitButton.dataset.defaultLabel = leadSubmitButton.textContent;

        function setLeadStatus(message = "", state) {
          leadStatus.textContent = message;
          leadStatus.classList.remove("is-success", "is-error", "is-pending");
          if (state) leadStatus.classList.add(`is-${state}`);
        }

        function openLeadModal(interest) {
          setLeadStatus();
          leadForm.reset();
          leadInterestInput.value = interest || "register";
          document.body.classList.add("is-modal-open");
          leadModal.setAttribute("aria-hidden", "false");
        }

        function closeLeadModal() {
          document.body.classList.remove("is-modal-open");
          leadModal.setAttribute("aria-hidden", "true");
        }

        leadTriggers.forEach((t) => t.addEventListener("click", () => openLeadModal(t.dataset.leadOpen)));
        leadCloseButtons.forEach((b) => b.addEventListener("click", closeLeadModal));
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && leadModal.getAttribute("aria-hidden") === "false") closeLeadModal();
        });

        leadForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          setLeadStatus("Enviando solicitud...", "pending");
          leadSubmitButton.disabled = true;
          leadSubmitButton.textContent = "Enviando...";

          const payload = Object.fromEntries(new FormData(leadForm).entries());

          try {
            const response = await fetch("/api/send-lead", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            const result = await response.json().catch(() => ({}));

            if (!response.ok || result?.ok === false) {
              throw new Error(result?.error || "No se pudo enviar la solicitud.");
            }

            setLeadStatus("¬°Gracias! Te contactaremos muy pronto.", "success");
            leadForm.reset();
          } catch (err) {
            setLeadStatus(err instanceof Error ? err.message : "Error enviando la solicitud.", "error");
          } finally {
            leadSubmitButton.disabled = false;
            leadSubmitButton.textContent = leadSubmitButton.dataset.defaultLabel;
          }
        });
      })();

      // Chat Isaak ‚Üí /api/vertex-chat (seguro)
      (function () {
        const fab = document.querySelector(".isaak-fab");
        const chat = document.getElementById("isaak-chat");
        const chatClose = chat.querySelector(".isaak-chat__close");
        const chatForm = chat.querySelector(".isaak-chat__form");
        const chatMessages = chat.querySelector(".isaak-chat__messages");
        const chatProactive = chat.querySelector(".isaak-chat__proactive");
        const chatInput = document.getElementById("isaak-input");

        const proactiveMessages = [
          "Hola üëã soy Isaak. ¬øQuieres que configuremos tus env√≠os VeriFactu?",
          "Puedo analizar tus m√°rgenes y detectar ahorros fiscales en minutos.",
          "¬øTe gu√≠o paso a paso para validar tu siguiente env√≠o a la AEAT?",
        ];

        function toggleChat(open) {
          const isOpen = open ?? chat.getAttribute("aria-hidden") === "true";
          chat.setAttribute("aria-hidden", String(!isOpen));
          fab.setAttribute("aria-expanded", String(isOpen));
          if (isOpen) chatInput.focus();
        }

        function addMessage({ from = "Isaak", text, pending = false }) {
          const message = document.createElement("div");
          message.className = `isaak-chat__message ${from === "Isaak" ? "from-isaak" : "from-user"}`;
          message.innerHTML = `
            <span class="isaak-chat__message-avatar">${from === "Isaak" ? "ü§ñ" : "üôã"}</span>
            <div>
              <p class="isaak-chat__message-label">${from}</p>
              <p class="isaak-chat__message-text">${text}</p>
            </div>
          `;
          if (pending) message.classList.add("is-pending");
          chatMessages.appendChild(message);
          chatMessages.scrollTop = chatMessages.scrollHeight;
          return message;
        }

        function showProactiveMessages() {
          chatProactive.innerHTML = "";
          proactiveMessages.forEach((text) => {
            const bubble = document.createElement("div");
            bubble.className = "isaak-chat__proactive-bubble";
            bubble.textContent = text;
            chatProactive.appendChild(bubble);
          });
        }

        async function sendIsaakMessage(prompt) {
          const pendingMessage = addMessage({ from: "Isaak", text: "Isaak est√° escribiendo...", pending: true });

          try {
            const response = await fetch("/api/vertex-chat", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ message: prompt }),
            });

            const data = await response.json().catch(() => ({}));
            const text = data?.text || data?.message || "No pude responder ahora mismo.";

            pendingMessage.classList.remove("is-pending");
            pendingMessage.querySelector(".isaak-chat__message-text").textContent = text;
          } catch {
            pendingMessage.classList.remove("is-pending");
            pendingMessage.querySelector(".isaak-chat__message-text").textContent =
              "No puedo conectarme con Isaak ahora mismo. Int√©ntalo m√°s tarde.";
          }
        }

        fab.addEventListener("click", () => toggleChat());
        chatClose.addEventListener("click", () => toggleChat(false));
        showProactiveMessages();

        chatForm.addEventListener("submit", (event) => {
          event.preventDefault();
          const message = chatInput.value.trim();
          if (!message) return;

          addMessage({ from: "T√∫", text: message });
          chatInput.value = "";
          sendIsaakMessage(message);
        });
      })();
    </script>
  </body>
</html>
